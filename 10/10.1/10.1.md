# 10.1. Listado de Procesos Batch

## Modulo 6 - 'Reporter√≠a'

El siguiente procedimiento se ejecuta diariamente para cargar las dimensiones de la estrella de reporte de deudas. Esta se encuentra en un tiempo D-1

#### SQL 

```sql
CREATE OR REPLACE PROCEDURE actualiza_dimensiones_y_hechos()
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO DIM_ANALISTA_RP (IND_ANALISTA, NAM_ANALISTA, REG_ANALISTA)
    SELECT COD_ANALISTA_COBRANZAS, 
           NOMBRE_ANALISTA_COBRANZA, 
           REGION_ANALISTA_COBRANZA
    FROM Analista_cobranza
    WHERE COD_ANALISTA_COBRANZAS NOT IN (SELECT IND_ANALISTA FROM DIM_ANALISTA_RP);

    INSERT INTO DIM_CLIENTE_RP (IND_CLIENTE, NAM_CLIENTE, STA_CLIENTE)
    SELECT COD_CLIENTE, 
           LEFT(NOMBRE, 50), 
           ESTADO_CLIENTE
    FROM Cliente
    WHERE COD_CLIENTE NOT IN (SELECT IND_CLIENTE FROM DIM_CLIENTE_RP);

    INSERT INTO DIM_CALENDARIO_RP (
        FECHA_CLN,
        PERIODO_CLN,
        YEAR_CLN,
        MES_CLN,
        MES_NOM_CLN,
        DIA_CLN,
        TRIM_CLN
    )
    SELECT 
        FECHA_VENCIMIENTO AS FECHA_CLN, 
        CAST(TO_CHAR(FECHA_VENCIMIENTO, 'YYYYMMDD') AS INTEGER) AS PERIODO_CLN,
        TO_CHAR(FECHA_VENCIMIENTO, 'YYYY') AS YEAR_CLN,
        CAST(TO_CHAR(FECHA_VENCIMIENTO, 'MM') AS INTEGER) AS MES_CLN,
        CASE TO_CHAR(FECHA_VENCIMIENTO, 'MM')
            WHEN '01' THEN 'Enero'
            WHEN '02' THEN 'Febrero'
            WHEN '03' THEN 'Marzo'
            WHEN '04' THEN 'Abril'
            WHEN '05' THEN 'Mayo'
            WHEN '06' THEN 'Junio'
            WHEN '07' THEN 'Julio'
            WHEN '08' THEN 'Agosto'
            WHEN '09' THEN 'Septiembre'
            WHEN '10' THEN 'Octubre'
            WHEN '11' THEN 'Noviembre'
            WHEN '12' THEN 'Diciembre'
        END AS MES_NOM_CLN,
        CAST(TO_CHAR(FECHA_VENCIMIENTO, 'DD') AS INTEGER) AS DIA_CLN,
        CASE 
            WHEN TO_CHAR(FECHA_VENCIMIENTO, 'MM') IN ('01', '02', '03') THEN 'Trim-1'
            WHEN TO_CHAR(FECHA_VENCIMIENTO, 'MM') IN ('04', '05', '06') THEN 'Trim-2'
            WHEN TO_CHAR(FECHA_VENCIMIENTO, 'MM') IN ('07', '08', '09') THEN 'Trim-3'
            WHEN TO_CHAR(FECHA_VENCIMIENTO, 'MM') IN ('10', '11', '12') THEN 'Trim-4'
        END AS TRIM_CLN
    FROM (
        SELECT DISTINCT FECHA_VENCIMIENTO 
        FROM Deuda
        WHERE FECHA_VENCIMIENTO IS NOT NULL
    ) AS SUBQUERY
    ON CONFLICT (FECHA_CLN) DO NOTHING; -- Evitar duplicados por fecha

    INSERT INTO FACT_REPORTE_DEUDAS (
        IND_ANALISTA,
        REG_ANALISTA,
        ESTADO_COBRANZA,
        IND_DATE,
        IND_CLIENTE,
        SUMA_MONTO_DEUDA_ANALISTA,
        SUMA_MONTO_DEUDA_REGION,
        CANTIDAD_CLIENTES_ATRASADO_ANALISTA,
        CANTIDAD_CLIENTES_AL_DIA_ANALISTA,
        CANTIDAD_CLIENTES_COBRANZA_ADMIN_TRIMESTRE
    )
    SELECT
        N.IND_ANALISTA,
        N.REG_ANALISTA,
        A.ESTADO_COBRANZA,
        T.IND_DATE,
        S.IND_CLIENTE,
        SUM(A.MONTO_DEUDA) OVER (PARTITION BY N.IND_ANALISTA) AS SUMA_MONTO_DEUDA_ANALISTA,
        SUM(A.MONTO_DEUDA) OVER (PARTITION BY N.REG_ANALISTA) AS SUMA_MONTO_DEUDA_REGION,
        COUNT(CASE WHEN A.ESTADO_DEUDA = 'Atrasado' THEN 1 END) OVER (PARTITION BY N.IND_ANALISTA) AS CANTIDAD_CLIENTES_ATRASADO_ANALISTA,
        COUNT(CASE WHEN A.ESTADO_DEUDA = 'Al dia' THEN 1 END) OVER (PARTITION BY N.IND_ANALISTA) AS CANTIDAD_CLIENTES_AL_DIA_ANALISTA,
        COUNT(CASE WHEN A.ESTADO_COBRANZA = 'Administrativa' THEN 1 END) OVER (PARTITION BY N.IND_ANALISTA, T.TRIM_CLN) AS CANTIDAD_CLIENTES_COBRANZA_ADMIN_TRIMESTRE
    FROM 
        DEUDA A
    LEFT JOIN DIM_CALENDARIO_RP T ON A.FECHA_VENCIMIENTO = T.FECHA_CLN
    LEFT JOIN DIM_ANALISTA_RP N ON A.COD_ANALISTA_COBRANZA = N.IND_ANALISTA
    LEFT JOIN DIM_CLIENTE_RP S ON A.COD_CLIENTE = S.IND_CLIENTE;

END;
$$;

CALL actualiza_dimensiones_y_hechos();
 ```