# 10.3. Tablas Involucradas (Entradas, Temporales, Salidas)

# Módulo 2 - 'Equipos'

##  **Tablas de Entrada**
Estas tablas contienen los datos originales necesarios para procesar las operaciones en el sistema.
- **Cliente**: Información de los clientes (`COD_CLIENTE`, `NOMBRE`, `RAZON_SOCIAL`, etc.)
- **Equipo**: Detalles de los equipos disponibles (`COD_EQUIPO`, `NOMBRE_EQUIPO`, `MARCA`, `MODELO`, etc.)
- **Pedido**: Registra los pedidos realizados, incluyendo el estado y monto (`COD_PEDIDO`, `COD_CLIENTE`, `ESTADO_PEDIDO`, `MONTO_PEDIDO`, etc.)
- **Pedido_Equipo**: Relaciona los pedidos con los equipos solicitados (`COD_PEDIDO`, `COD_EQUIPO`, `CANTIDAD_PEDIDA`, `MONTO_EQUIPO`).

##  **Tablas Temporales**
Tablas o vistas intermedias que se usan para cálculos y transformaciones de datos.

- **Vista `detalles_pedido_equipo`**: Combina las tablas `Pedido`, `Pedido_Equipo` y `Equipo` para mostrar los detalles de los pedidos pendientes.

  ```sql
  CREATE VIEW detalles_pedido_equipo AS
  SELECT 
      p.cod_pedido,
      p.cod_cliente,
      p.fecha_reg_pedido,
      p.fecha_evaluacion,
      p.estado_pedido,
      p.metodo_pago,
      p.tipo_pedido,
      p.monto_pedido,
      pe.cod_equipo,
      e.nombre_equipo,
      e.marca,
      e.modelo,
      e.precio_unitario,
      pe.cantidad_pedida,
      pe.monto_equipo,
      p.observaciones
  FROM 
      pedido p
  JOIN 
      pedido_equipo pe ON p.cod_pedido = pe.cod_pedido
  JOIN 
      equipo e ON pe.cod_equipo = e.cod_equipo
  WHERE 
      p.estado_pedido = 'Pendiente';  





## **Tablas de Salida**
Estas tablas almacenan los resultados finales después de procesar los datos.

- **Pedido_Equipo**: Relaciona los pedidos con los equipos y sus cantidades. Se actualiza cuando se acepta un pedido y se ajusta el stock de los equipos.
- **Factura**: Contiene la información de las facturas generadas por los pedidos aceptados. Esta tabla está relacionada con el `COD_PEDIDO`.
- **Cliente**: Después de procesar el pedido, se actualiza la línea de crédito del cliente en la tabla `Cliente`, reflejando los cambios en su crédito disponible.


# Módulo 3 - Recargas

# **Tablas de Entrada**
Estas tablas contienen los datos originales necesarios para procesar las operaciones en el sistema.

**Cliente**: Contiene información básica de los clientes (COD_CLIENTE, NOMBRE, RAZON_SOCIAL, CREDITO_MAXIMO, etc.).

**Recarga:** Registra los datos de los pedidos de recarga realizados (COD_RECARGA, COD_CLIENTE, MONTO_RECARGA, ESTADO_RECARGA, etc.).

# **Tablas Temporales**
Tablas o vistas intermedias que se usan para cálculos y transformaciones de datos.

**Vista** evaluacion_recarga: Combina las tablas Recarga y Cliente para mostrar los pedidos de recarga pendientes con información del cliente y los detalles de la solicitud.


  ```sql
CREATE VIEW evaluacion_recarga AS
SELECT 
    r.cod_recarga,
    r.cod_cliente,
    c.nombre AS nombre_cliente,
    c.razon_social,
    r.monto_solicitado,
    r.fecha_solicitud,
    r.estado_recarga,
    c.credito_disponible,
    c.deuda_vencida
FROM 
    recarga r
JOIN 
    cliente c ON r.cod_cliente = c.cod_cliente
WHERE 
    r.estado_recarga = 'Pendiente'; 
    
```

**Resultado de la Vista**

cod_recarga: Identificador único de la recarga.
cod_cliente: Identificador único del cliente que solicita la recarga.
nombre_cliente: Nombre del cliente.
razon_social: Razón social del cliente.
monto_recarga: Monto solicitado en la recarga.
estado_recarga: Estado actual del pedido ("Pendiente").
linea_credito: Línea de crédito disponible del cliente.


# **Tablas de Salida**
Estas tablas almacenan los resultados finales después de procesar los datos.

**Recarga:** Se actualiza con el estado final del pedido (aprobado o rechazado) y, si es aprobado, con el monto facturado.

**Factura:** Contiene la información de las facturas generadas por los pedidos de recarga aceptados (COD_FACTURA, COD_RECARGA, MONTO_FACTURA, FECHA_FACTURA, etc.).

**Cliente:** Actualiza el crédito disponible del cliente tras la aprobación de un pedido de recarga.


# Módulo 3 - Recargas

# **Tablas de Entrada**
Estas tablas son las dimensiones que se crearan para la estrella

**DIM_CLIENTE**: Contiene información relevante de la cliente

**DIM_CALENDARIO:** Contiene los datos descompuestos de la columna fecha_vencimiento en la tabla Deuda

**DIM_ANALISTA:** Registra los analistas en la tabla analista cobranza

# **Tablas Temporales**


**Vista** Reporte de cobranza administrativa: En esta vista se mostrara los detalles de la cantidad de clientes con cobranza administrativa para cada analista.


  ```sql
CREATE VIEW reporte_cob_administrativa AS
SELECT 
    F.IND_ANALISTA AS Analista, 
    T.TRIM_CLN AS TRIMESTRE, 
    T.YEAR_CLN AS YEAR, 
    F.CANTIDAD_CLIENTES_COBRANZA_ADMIN_TRIMESTRE AS Cant_cobr_admin
FROM 
    FACT_REPORTE_DEUDAS F
LEFT JOIN 
    DIM_CALENDARIO_RP T ON F.IND_DATE = T.IND_DATE
GROUP BY 
    F.IND_ANALISTA, 
    T.TRIM_CLN, 
    T.YEAR_CLN, 
    F.CANTIDAD_CLIENTES_COBRANZA_ADMIN_TRIMESTRE
HAVING 
    F.CANTIDAD_CLIENTES_COBRANZA_ADMIN_TRIMESTRE != 0
ORDER BY 
    F.IND_ANALISTA, 
    T.YEAR_CLN, 
    T.TRIM_CLN;
    
```

**Resultado de la Vista**

cod_analista: Identificador unico del analista
tri_cln: Trimestre donde se encuentra la fecha vencida
year_cln: Año donde se encuentra la fecha vencida de la deuda
cantida_cobr_admin: Cantidad de clientes con cobranza administrativa


# **Tablas de Salida**
La tabla de hechos fact_reporte_deudas:

CREATE TABLE FACT_REPORTE_DEUDAS AS
SELECT
    N.IND_ANALISTA,
    N.REG_ANALISTA,
    A.ESTADO_COBRANZA,
    T.IND_DATE,
    S.IND_CLIENTE,
    SUM(A.MONTO_DEUDA) OVER (PARTITION BY N.IND_ANALISTA) AS SUMA_MONTO_DEUDA_ANALISTA,
    SUM(A.MONTO_DEUDA) OVER (PARTITION BY N.REG_ANALISTA) AS SUMA_MONTO_DEUDA_REGION,
    COUNT(CASE WHEN A.ESTADO_DEUDA = 'Atrasado' THEN 1 END) OVER (PARTITION BY N.IND_ANALISTA) AS CANTIDAD_CLIENTES_ATRASADO_ANALISTA,
    COUNT(CASE WHEN A.ESTADO_DEUDA = 'Al dia' THEN 1 END) OVER (PARTITION BY N.IND_ANALISTA) AS CANTIDAD_CLIENTES_AL_DIA_ANALISTA,
    COUNT(CASE WHEN A.ESTADO_COBRANZA = 'Administrativa' THEN 1 END) OVER (PARTITION BY N.IND_ANALISTA, T.TRIM_CLN) AS CANTIDAD_CLIENTES_COBRANZA_ADMIN_TRIMESTRE
FROM 
    DEUDA A
LEFT JOIN DIM_CALENDARIO_RP T ON A.FECHA_VENCIMIENTO = T.FECHA_CLN
LEFT JOIN DIM_ANALISTA_RP N ON A.COD_ANALISTA_COBRANZA = N.IND_ANALISTA
LEFT JOIN DIM_CLIENTE_RP S ON A.COD_CLIENTE = S.IND_CLIENTE

**Nota**: Esta tabla se crea con el fin de tener disponible calculos de manera rápida y de fácil acceso respecto a las deudas.